name: Deployment Workflow
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  changes:
    outputs:
      projects: ${{ steps.changes.outputs.projects }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: json
          filters: |
            changed: 'lambda/*/**'
      - id: changes
        env:
          changed: ${{ steps.filter.outputs.changed_files }}
        run: |
          projects="$( echo $changed | jq -r '.[]' | cut -d'/' -f1,2 | sort | uniq | jq -s -R -c 'split("\n") | map(select(. != ""))' )"
          echo "projects=${projects}" >> $GITHUB_OUTPUT

  build:
    needs: changes
    if: needs.changes.outputs.projects != '[]'
    strategy:
      matrix:
        project: ${{ fromJSON(needs.changes.outputs.projects) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo "これビルドするよ～ ${{ matrix.project }}"
        if: ${{ hashFiles(format('{0}{1}', matrix.project, '/package.json')) != '' }}
        working-directory: ${{ matrix.project }}
      - run: echo "デプロイするよ～ ${{ matrix.project }}"
